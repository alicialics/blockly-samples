<!doctype html>
<html>
  <head>
    <!-- INJECTED HEADER -->
    <meta name="viewport" content="width=device-width,maximum-scale=2" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,500italic,700,700italic"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link rel="stylesheet" href="./css/main.css" />
    <link rel="stylesheet" href="./css/custom.css" />
    <!-- END INJECTED HEADER -->
    <meta charset="utf-8" />
    <title>Blockly Demo: Step Execution with Python Interpreter</title>
    <script src="toolbox.js"></script>
    <script src="./public/blockly/blockly_compressed.js"></script>
    <script src="./public/blockly/blocks_compressed.js"></script>
    <script src="./public/blockly/python_compressed.js"></script>
    <script src="./public/blockly/msg/en.js"></script>
    <style>
      body {
        background-color: #fff;
        font-family: sans-serif;
      }
      h1 {
        font-weight: normal;
        font-size: 140%;
      }
    </style>
  </head>
  <body class="root">
    <!-- NAV BAR -->
    <nav id="toolbar">
      <div class="title-grow">
        <div class="title">Python Interpreter</div>
      </div>
      <a
        href="https://github.com/alicialics/blockly-samples/blob/blockly_python_interpreter/examples/python-interpreter-demo"
        class="button"
        target="_blank"
        >View code</a
      >
    </nav>
    <!-- END NAV BAR -->
    <main id="main" class="has-tabs">
      <div class="drop-shadow"></div>
      <!-- PAGE TABS -->
      <ul id="tabs">
        <li>
          <a href="./step-execution.html"> Step Execution </a>
        </li>

        <li>
          <a href="./async-execution.html"> Async Execution </a>
        </li>

        <li>
          <a href="./main-execution.html"> Main Thread Execution </a>
        </li>
      </ul>
      <!-- END PAGE TABS -->
      <h1>Step Execution with Python Interpreter</h1>

      <p>
        This is a demo of executing code step-by-step with a sandboxed Python
        interpreter on the main thread.
      </p>

      <p>
        The generator's <code>python.pythonGenerator.STATEMENT_PREFIX</code> is
        assigned <code>'highlightBlock(%1);\nawait breakpoint()\n'</code>, where
        <code>%1</code> is the block ID. The call to
        <code>highlightBlock()</code> will highlight the identified block and
        <code>await breakpoint()</code> will pause the execution.
      </p>

      <p>
        Each press of the "Step Python" button will run the interpreter one
        step. That is, until <code>highlightBlock()</code> has highlighted the
        block that will be executed on the next step.
      </p>

      <p>
        <button onclick="stepCode()" id="stepButton">Step Python</button>
      </p>

      <div style="width: 100%">
        <div
          id="blocklyDiv"
          style="display: inline-block; height: 480px; width: 58%"
        ></div>
        <textarea
          id="output"
          disabled="disabled"
          style="display: inline-block; height: 480px; width: 38%"
        >
        </textarea>
      </div>

      <script>
        const startBlocks = {
          blocks: {
            blocks: [
              {
                type: "variables_set",
                x: 20,
                y: 20,
                inline: true,
                fields: {
                  VAR: { id: "n" },
                },
                inputs: {
                  VALUE: {
                    block: {
                      type: "math_number",
                      fields: { NUM: 1 },
                    },
                  },
                },
                next: {
                  block: {
                    type: "controls_repeat_ext",
                    inline: true,
                    inputs: {
                      TIMES: {
                        block: {
                          type: "math_number",
                          fields: { NUM: 4 },
                        },
                      },
                      DO: {
                        block: {
                          type: "variables_set",
                          inline: true,
                          fields: {
                            VAR: { id: "n" },
                          },
                          inputs: {
                            VALUE: {
                              block: {
                                type: "math_arithmetic",
                                fields: { OP: "MULTIPLY" },
                                inputs: {
                                  A: {
                                    block: {
                                      type: "variables_get",
                                      fields: {
                                        VAR: { id: "n" },
                                      },
                                    },
                                  },
                                  B: {
                                    block: {
                                      type: "math_number",
                                      fields: { NUM: 2 },
                                    },
                                  },
                                },
                              },
                            },
                          },
                          next: {
                            block: {
                              type: "text_print",
                              inputs: {
                                TEXT: {
                                  block: {
                                    type: "variables_get",
                                    fields: {
                                      VAR: { id: "n" },
                                    },
                                  },
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
              },
            ],
          },
          variables: [
            {
              name: "n",
              id: "n",
            },
          ],
        };

        const demoWorkspace = Blockly.inject("blocklyDiv", {
          media: "./public/blockly/media/",
          toolbox: toolboxJson,
        });
        python.pythonGenerator.STATEMENT_PREFIX =
          "highlightBlock(%1)\nawait breakpoint()\n";
        python.pythonGenerator.addReservedWords("highlightBlock");
        python.pythonGenerator.addReservedWords("breakpoint");
        Blockly.serialization.workspaces.load(startBlocks, demoWorkspace);

        const outputArea = document.getElementById("output");
        const stepButton = document.getElementById("stepButton");

        function loadMicropython_() {
            var INTERPRETER_BASE_PATH = "./public";
            return new Promise(function (resolve) {
                import(INTERPRETER_BASE_PATH + "/micropython.mjs").then(function (module) {
                    module.loadMicroPython({
                        url: INTERPRETER_BASE_PATH + "/micropython.wasm"
                    }).then(function (interpreter) {
                       resolve(interpreter);
                    });
                });
            });
        }
        var micropythonPromise = loadMicropython_();
        let inProgress = null;
        let micropython = null;
        micropythonPromise.then(interpreter => { micropython = interpreter; } )

        let abortExecution_;
        let resumeExecution_;

        function initApi() {
          // Add an API function for the alert() block, generated for "text_print" blocks.
          const wrapperAlert = function alert(text) {
            text = arguments.length ? text : "";
            outputArea.value += "\n" + text;
          };
          globalThis.print = wrapperAlert;

          // Add an API function for the prompt() block.
          const wrapperPrompt = function prompt(text) {
            return window.prompt(text);
          };
          globalThis.input = wrapperPrompt;

          // Add an API function for highlighting blocks.
          const wrapperHighlight = function (id) {
            id = String(id || "");
            return highlightBlock(id);
          };
          // globalThis.highlightBlock = highlightBlock;

          function wrapperBreakpoint() {
            return new Promise(function (resolve, reject) {
                resumeExecution_ = resolve;
                abortExecution_ = reject;
            });
          }

          globalThis.breakpoint = wrapperBreakpoint;
        }

        // Each step will run the interpreter until the highlightPause is true.
        let highlightPause = false;

        function highlightBlock(id) {
          demoWorkspace.highlightBlock(id);
          highlightPause = true;
        }

        function resetStepUi(clearOutput) {
          demoWorkspace.highlightBlock(null);
          highlightPause = false;

          if (clearOutput) {
            outputArea.value = "Program output:\n=================";
          }

          if (abortExecution_) {
            abortExecution_();
          }
          inProgress = null;
        }

        async function stepCode() {
          let hasMoreCode;
          if (!inProgress) {
            // First statement of this code.
            // Clear the program output.
            resetStepUi(true);
            let latestCode =
              python.pythonGenerator.workspaceToCode(demoWorkspace);
            latestCode = "from js import highlightBlock, breakpoint, print, input\n" + latestCode;
            inProgress = true;
            initApi();
            alert(
                "Ready to execute the following code\n" +
                  "===================================\n" +
                  latestCode,
              );
            await micropython.runPythonAsync(latestCode);

            // And then show generated code in an alert.
            // In a timeout to allow the outputArea.value to reset first.
            setTimeout(function () {
              highlightPause = true;
              stepCode();
            }, 1);
            return;
          }
          highlightPause = false;
          hasMoreCode = true;

          try {
            if (resumeExecution_) {
              resumeExecution_();
              resumeExecution_ = null;
            } else {
              hasMoreCode = false;
            }
          } finally {
            if (!hasMoreCode) {
              // Program complete, no more code to execute.
              outputArea.value += "\n\n<< Program complete >>";

              resetStepUi(false);

              // Cool down, to discourage accidentally restarting the program.
              stepButton.disabled = "disabled";
              setTimeout(function () {
                stepButton.disabled = "";
              }, 2000);
            }
          }
        }

        demoWorkspace.addChangeListener(function (event) {
          if (!event.isUiEvent) {
            // Something changed.  Interpreter needs to be reloaded.
            resetStepUi(true);
          }
        });
      </script>
    </main>
  </body>
</html>
